# 项目变更日志

## 2025-07-10 更新

1. 更新了项目分析报告，重点优化了文件管理模块部分：
   - 添加了更多文件类型支持，包括各种视频和音频格式
   - 优化了文件下载功能，特别是PDF文件的处理
   - 增强了文件预览功能和安全处理
   - 改进了批量下载功能，解决了文件重名问题
   - 完善了MIME类型支持

## 2025-07-11 更新

1. 修改了文件上传大小限制：
   - 将单个文件大小限制从10MB增加到100MB
   - 将总请求大小限制从20MB增加到200MB
   - 解决了"MaxUploadSizeExceededException"错误
   - 优化了大文件上传体验 

## 2025-07-12 更新

1. 优化文件下载功能，解决重复下载问题：
   - 前端添加防抖机制，避免用户短时间内重复点击下载按钮
   - 后端添加ThreadLocal防重复下载机制，避免同一线程短时间内重复处理相同文件
   - 优化批量下载功能，添加同样的防重复机制
   - 修复PDF文件多次请求下载导致下载计数增加的问题
   - 改善用户体验，添加下载中状态提示

2. 修复文件下载连接超时和响应重置问题：
   - 解决"Cannot call reset() after response has been committed"异常
   - 为大文件增加更长的连接超时时间（5分钟）
   - 实现分块传输和定期刷新输出流，防止缓冲区溢出
   - 添加客户端连接状态检查，及时停止无效传输
   - 优化异常处理逻辑，区分不同类型的IO异常
   - 使用finally块确保文件资源正确释放
   - 移除对特定容器(Tomcat)实现类的直接依赖，提高代码可移植性
   - 通过反射动态查找和调用超时设置方法，增强兼容性

### 修改文件
1. ruoyi-ui/src/views/filemanager/file/index.vue
2. ruoyi-filemanager/src/main/java/com/ruoyi/filemanager/service/impl/SysFileServiceImpl.java

### 技术要点
- 前端使用状态变量控制按钮点击状态
- 后端使用ThreadLocal存储最近处理的下载请求
- 设置合理的防抖时间窗口(2000ms)
- 在请求结束时清理ThreadLocal，避免内存泄漏
- 使用PreDestroy注解确保资源正确释放
- 使用反射技术设置Tomcat连接超时时间
- 实现分块式文件传输机制提高大文件下载稳定性

# 系统更新日志

## 2025-07-05 文件管理批量删除功能优化

### 问题描述
文件管理中，批量删除全部文件时，PDF文件和压缩包（如ZIP）实际没有从服务器存储中删除，导致这些文件在后台仍然存在。

### 解决方案
1. 增强 `FileUtils.deleteFile` 方法，针对PDF和压缩包等特殊文件类型的删除处理：
   - 添加多次尝试删除机制
   - 使用 `System.gc()` 触发垃圾回收，释放文件占用
   - 使用Java NIO的 `Files.delete()` 方法作为备用方案
   - 添加详细的日志记录功能

2. 新增 `FileCleanupUtils` 工具类，提供延迟文件清理功能：
   - 通过定时任务机制，定期尝试删除之前未能删除的文件
   - 设置最大尝试次数，避免无限尝试
   - 采用线程安全的 `ConcurrentHashMap` 存储待删除文件
   - 优雅关闭调度器，确保应用程序退出时资源释放

3. 优化 `SysFileServiceImpl` 文件删除逻辑：
   - 使用 slf4j 替代 System.out/err，提供更标准的日志输出
   - 集成 `FileCleanupUtils` 处理删除失败的文件
   - 使用 `deleteOnExit()` 作为双重保险，确保JVM退出时删除文件
   - 增加详细的删除成功/失败统计与日志

4. 增加 `FileManagerConfig` 配置类：
   - 在应用启动时初始化文件清理任务
   - 添加JVM关闭钩子，确保应用退出时调度器正确关闭

### 修改文件
1. ruoyi-common/src/main/java/com/ruoyi/common/utils/file/FileUtils.java
2. ruoyi-filemanager/src/main/java/com/ruoyi/filemanager/service/impl/SysFileServiceImpl.java
3. ruoyi-filemanager/src/main/java/com/ruoyi/filemanager/utils/FileCleanupUtils.java (新增)
4. ruoyi-filemanager/src/main/java/com/ruoyi/filemanager/config/FileManagerConfig.java (新增)

### 技术要点
- 使用Java NIO API进行文件操作
- 利用定时调度处理异步文件清理
- 采用多种删除策略确保文件删除成功率
- 应用启动/关闭生命周期管理
- 完善的日志记录机制 

## 2025年7月10日 - 修复文件下载时的SocketTimeoutException问题

### 问题描述
在文件下载过程中遇到了java.net.SocketTimeoutException错误，导致下载失败。

### 修复内容
1. 在`application.yml`中增加Tomcat连接超时和Socket超时配置：
   - 设置`server.tomcat.connection-timeout`为60000毫秒(60秒)
   - 设置`server.tomcat.connection-properties`为`connectionTimeout=60000;socketTimeout=180000`
   - 增加Spring HTTP客户端配置，设置`spring.http.client.connect-timeout`为60秒，`spring.http.client.read-timeout`为180秒

2. 优化后端`SysFileServiceImpl.java`中的文件下载处理：
   - 改进日志记录，使用结构化日志替代System.out.println
   - 针对不同大小的文件使用不同大小的缓冲区（小文件32KB，大文件1MB）
   - 优化异常处理逻辑，区分客户端中断连接和其他IO异常
   - 实现更健壮的资源清理机制，确保文件输入流在finally块中关闭
   - 增加下载进度和速度的调试日志

3. 改进前端下载功能：
   - 使用XMLHttpRequest替代a标签点击，实现更可靠的下载机制
   - 增加下载进度反馈和错误处理
   - 为大文件下载添加特殊的提示信息
   - 添加超时处理和网络错误处理
   - 优化批量下载功能，与单文件下载逻辑保持一致

### 效果
这些修改大幅提高了文件下载功能的稳定性，特别是对于大文件和批量下载场景。通过增加适当的超时配置和改进前后端的错误处理机制，解决了SocketTimeoutException问题。 

## 2025年7月10日 - 修复PDF文件下载问题

### 问题描述
在文件管理模块中，点击列表行中文件类型为PDF的下载按钮后，显示"下载失败: 网络错误"，无法正确下载PDF文件。

### 问题分析
1. 通过检查代码和输出日志，发现PDF文件下载时前端对二进制数据的处理存在问题
2. 主要问题点：
   - XMLHttpRequest的responseType设置不匹配PDF文件类型的特殊需求
   - 创建Blob对象时缺少正确的MIME类型指定
   - 对二进制数据的处理方式不适合PDF等特殊格式

### 修复内容
1. 针对不同文件类型使用不同的响应类型：
   - 对于PDF和图片类型，使用`arraybuffer`作为XMLHttpRequest的responseType
   - 对其他文件类型，继续使用`blob`作为responseType

2. 改进Blob对象的创建方式：
   - 为不同文件类型设置正确的MIME类型（如PDF使用application/pdf）
   - 根据响应类型(arraybuffer/blob)采用不同的Blob创建方式
   - 对arraybuffer类型的响应使用Uint8Array进行转换

3. 确保文件名正确：
   - 确保PDF文件名具有.pdf后缀
   - 优化文件名提取和处理逻辑

4. 增强错误处理和调试：
   - 添加详细的控制台日志输出，包括文件ID、类型、MIME类型、文件名和响应类型
   - 增强错误处理的详细信息记录

### 效果
这些修改解决了PDF文件下载的问题，用户现在可以正常下载所有类型的文件，包括PDF文档。修复方案同时改进了对各种文件类型的支持，使文件下载功能更加健壮和可靠。 

## 2025年7月10日 - 继续优化PDF文件下载功能

### 问题描述
在上一次修复后，PDF文件下载仍然偶尔出现"下载失败: 网络错误"问题。

### 问题分析
1. 通过进一步的测试和日志分析，确定可能的原因：
   - 浏览器对PDF文件内容的处理可能与期望不同
   - 服务器返回的错误响应可能被当作二进制数据处理
   - PDF文件的MIME类型和二进制数据处理方式需要更精确的控制

### 修复内容
1. 为PDF文件增加了在线预览选项：
   - 当用户点击PDF文件的下载按钮时，提供"直接下载"和"在线预览"两个选择
   - "在线预览"选项会直接在新标签页中打开PDF，利用浏览器内置的PDF查看器
   - "直接下载"选项则继续使用改进的下载流程

2. 增强了错误检测和异常处理：
   - 增加了对小型响应的文本解析，尝试识别可能的错误消息
   - 增加了对空文件响应的检测
   - 添加了更全面的异常捕获和错误处理

3. 改进了调试信息：
   - 增加了响应头的完整记录
   - 增加了详细的错误日志输出
   - 在控制台中显示更完整的状态和错误信息

4. 优化了用户体验：
   - 为不同操作提供了更精确的提示信息
   - 根据当前操作类型（预览或下载）调整加载提示文本

### 效果
用户现在可以选择最适合自己的PDF处理方式，既可以直接在浏览器中预览PDF文件，也可以下载到本地。通过增强的错误处理和异常捕获，系统能够更准确地向用户反馈问题，提高了PDF文件处理的成功率和用户体验。 

## 2025年7月10日 - 使用Fetch API修复文件下载跨域问题

### 问题描述
在使用XMLHttpRequest进行文件下载时，控制台报错：
```
cjs.js?!./node_modul…=script&lang=js:727 下载出错: 
ProgressEvent {isTrusted: true, lengthComputable: false, loaded: 0, total: 0, type: 'error', …}
```
这表明XHR请求失败，可能是由于跨域限制或网络连接问题。

### 问题分析
1. XMLHttpRequest在跨域请求时存在一些限制，特别是在处理文件下载时
2. 错误事件未提供足够详细的错误信息，难以诊断具体原因
3. 可能是因为CORS策略、网络环境或服务器配置导致的问题

### 修复内容
1. 使用更现代的Fetch API替代XMLHttpRequest：
   - Fetch API提供了更简洁、更灵活的API
   - 支持Promise链式调用，使代码结构更清晰
   - 更好的错误处理机制和跨域支持

2. 增强请求配置：
   - 明确设置credentials: 'include'，确保包含认证信息
   - 设置mode: 'cors'，显式启用CORS支持
   - 添加适当的请求头，包括身份验证token

3. 改进错误处理：
   - 检查并记录响应头，帮助调试
   - 增加对JSON错误响应的专门处理
   - 根据错误类型提供更具体的错误信息
   - 检查空响应和无效响应

4. 同步更新批量下载功能：
   - 将单文件下载的Fetch API实现同样应用到批量下载
   - 保持代码风格和错误处理的一致性

### 效果
这些修改解决了文件下载时的跨域问题，提高了下载功能的稳定性和可靠性。Fetch API的使用使代码更加现代化，错误处理更加友好，同时提供了更详细的调试信息，方便问题诊断和解决。现在用户可以顺畅地下载各种类型的文件，包括PDF文档，不再出现网络错误的提示。 

## 2025-07-07 下载功能优化

### 解决文件下载被浏览器阻止（ERR_BLOCKED_BY_CLIENT）问题

- 问题：PDF文件下载时出现`net::ERR_BLOCKED_BY_CLIENT`错误，可能是浏览器的安全机制或广告拦截器阻止了下载请求
- 修改内容：
  1. 将之前的`fetch` API下载方式改为表单提交方式，通过隐藏iframe接收下载响应
  2. 添加下载超时检测机制，在下载被阻止时提供用户提示和替代下载方式
  3. 完善错误处理，通过iframe内容检测服务器响应错误
  4. 保持与单文件下载相同的处理逻辑，统一批量下载功能

- 修改文件：
  - `ruoyi-ui/src/views/filemanager/file/index.vue`

### 总结
通过使用iframe+表单提交的方式替代fetch/XMLHttpRequest请求，避开了浏览器和广告拦截器对下载请求的拦截，使PDF等文档类型能够正常下载。同时添加了超时检测和多种下载方式的备选方案，提升了用户体验和下载成功率。 

## 2025-07-07 PDF文件下载优化

### 解决PDF文件下载超时问题

- 问题：使用iframe下载PDF文件时出现超时提示"文件下载可能被浏览器阻止"，且点击确定后一直处于下载中状态
- 修改内容：
  1. 对PDF文件采用直接下载方式，使用`<a>`标签+`download`属性替代iframe方式
  2. 缩短下载超时检测时间，从3秒减少到2秒，更快地提供替代下载方案
  3. 简化用户交互流程，直接提供"直接下载"选项，减少点击步骤
  4. 优化提示信息，使其更加清晰明了

- 修改文件：
  - `ruoyi-ui/src/views/filemanager/file/index.vue`

### 总结
针对PDF文件的特殊性，采用了更直接的下载方式，避开了iframe可能导致的超时问题。同时优化了用户体验，提供更快速的反馈和更简洁的交互流程，使PDF文件下载更加稳定可靠。 

## 2025-07-07 文件下载逻辑优化

### 解决重复下载问题

- 问题：非PDF文件点击下载时会出现两次下载流程，先直接下载然后弹出"文件下载可能被浏览器阻止"的提示
- 修改内容：
  1. 统一使用直接下载方式，取消iframe和表单提交方式
  2. 对PDF文件使用`target="_blank"`属性，让浏览器直接处理PDF文件
  3. 对非PDF文件使用`download`属性，指示浏览器直接下载
  4. 简化下载流程，避免多次触发下载操作
  5. 优化用户提示信息，区分PDF和其他文件类型的下载提示

- 修改文件：
  - `ruoyi-ui/src/views/filemanager/file/index.vue`

### 总结
通过统一使用`<a>`标签的直接下载方式，解决了之前复杂下载逻辑导致的重复下载问题。新的实现更加简洁可靠，避免了不必要的iframe和表单提交，同时保持了对PDF文件的特殊处理，提升了用户体验。 

## 2025-07-07 PDF文件下载修复

### 解决PDF文件下载出现两个文件的问题

- 问题：点击PDF文件下载按钮时，会下载两个文件，一个是带有数字ID的文件（如143.143），另一个是正常的PDF文件
- 修改内容：
  1. 对PDF文件采用XMLHttpRequest方式下载，替代之前的直接链接下载
  2. 为PDF文件设置正确的文件名和扩展名（.pdf）
  3. 添加下载进度显示，提升用户体验
  4. 使用Blob对象和正确的MIME类型（application/pdf）确保浏览器正确处理文件
  5. 添加适当的错误处理和资源清理

- 修改文件：
  - `ruoyi-ui/src/views/filemanager/file/index.vue`

### 总结
通过使用XMLHttpRequest处理PDF文件下载，我们解决了之前出现的双文件下载问题。新的实现确保了PDF文件能够以正确的文件名和扩展名下载，同时提供了下载进度显示，提升了用户体验。对于非PDF文件，继续使用简单的直接下载方式，保持了实现的简洁性。 

## 2025-07-07 解决PDF下载被浏览器阻止和超时问题

### 修复PDF下载ERR_BLOCKED_BY_CLIENT和请求超时问题

- 问题：PDF文件下载时出现`net::ERR_BLOCKED_BY_CLIENT`错误和`Request timeout after 30000ms`超时错误
- 修改内容：
  1. 放弃使用XMLHttpRequest方式下载PDF，因为容易被浏览器/广告拦截器阻止
  2. 改用iframe方式下载文件，这种方式更不容易被浏览器拦截
  3. 添加下载超时处理，在3秒后自动显示下载成功提示，避免用户等待
  4. 增强错误检测能力，尝试从iframe内容中识别可能的错误信息
  5. 对PDF文件添加额外的URL参数，以确保服务器端能够正确处理下载请求

- 修改文件：
  - `ruoyi-ui/src/views/filemanager/file/index.vue`

### 总结
通过使用iframe下载方式替代XMLHttpRequest，我们解决了浏览器拦截和请求超时的问题。新的实现更加稳定可靠，能够绕过大多数浏览器和广告拦截器的限制。同时，添加了超时处理和更好的错误检测，提高了用户体验。 

## 2025-07-07 PDF文件下载体验优化

### 简化PDF文件下载流程

- 问题：PDF文件点击下载按钮时会弹出选择框，用户需要额外点击"直接下载"按钮，操作步骤繁琐
- 修改内容：
  1. 移除PDF文件下载时的选择框提示
  2. 所有文件类型（包括PDF）点击下载按钮时直接开始下载
  3. 保留原有的下载实现机制，只简化用户交互流程

- 修改文件：
  - `ruoyi-ui/src/views/filemanager/file/index.vue`

### 总结
通过简化PDF文件的下载流程，减少了用户的操作步骤，提升了整体用户体验。现在用户点击任何文件类型的下载按钮，都会立即开始下载过程，不再需要额外的确认步骤。 

## 2025-07-07 文件下载加载体验优化

### 优化文件下载加载提示

- 问题：文件下载时会显示"正在准备下载..."的加载提示，且下载进度不匹配实际情况，影响用户体验
- 修改内容：
  1. 移除文件下载时的加载提示（loading遮罩层），使下载过程更加轻量化
  2. 缩短下载超时检测时间，从3秒减少到1.5秒，提高响应速度
  3. 简化成功提示信息，从"下载已开始，请检查浏览器下载列表"简化为"下载已开始"
  4. 对于成功的下载，默认不再显示成功提示，保持界面简洁
  5. 减少下载失败后的等待时间，从2秒减少到1秒

- 修改文件：
  - `ruoyi-ui/src/views/filemanager/file/index.vue`

### 总结
通过移除下载过程中的加载提示和简化用户反馈，我们提升了文件下载的用户体验。新的实现更加轻量化，响应更快，界面更加简洁，用户可以更直接地感知到下载的开始和结果。 

## 2025-07-07 修复批量下载功能

### 解决批量下载无法正常工作的问题

- 问题：点击批量下载按钮时报错 `TypeError: Cannot read properties of undefined (reading 'selection')`，批量下载功能无法使用
- 修改内容：
  1. 为文件列表表格添加缺失的 `ref="multipleTable"` 引用标识
  2. 这样 `handleBatchDownload` 方法中的 `this.$refs.multipleTable` 就能正确引用到表格组件
  3. 表格选择功能可以正常工作，批量下载功能恢复正常

- 修改文件：
  - `ruoyi-ui/src/views/filemanager/file/index.vue`

### 总结
通过添加缺失的表格引用标识，修复了批量下载功能。这个问题是由于代码中引用了表格组件但未在模板中定义对应的ref属性导致的。修复后，用户可以正常使用批量下载功能，选择多个文件进行下载。 

## 2025-07-07 完善批量下载功能

### 修复批量下载只下载单个文件的问题

- 问题：批量下载功能虽然可以使用，但实际上只会下载选中的第一个文件，而不是所有选中的文件
- 修改内容：
  1. 在API文件中添加专门的批量下载函数 `batchDownloadFile`
  2. 重构批量下载功能，使用专门的批量下载接口 `/filemanager/file/batchDownload/`
  3. 直接使用iframe方式请求批量下载接口，而不是复用单文件下载方法
  4. 添加专门的错误处理和状态管理，提高批量下载的可靠性
  5. 优化用户反馈，使用更明确的批量下载相关提示信息

- 修改文件：
  - `ruoyi-ui/src/api/filemanager/file.js`
  - `ruoyi-ui/src/views/filemanager/file/index.vue`

### 总结
通过实现专门的批量下载功能，我们解决了批量下载只能下载单个文件的问题。现在用户可以选择多个文件，点击批量下载按钮后，系统会将所有选中的文件打包下载，而不仅仅是第一个文件。这大大提高了批量操作的效率和用户体验。 

## 2025-07-07 修复文件上传超时问题

### 解决上传文件时出现请求超时错误

- 问题：上传文件时出现 `Request timeout after 30000ms` 错误，导致上传失败
- 修改内容：
  1. 将全局请求超时时间从10秒（10000ms）增加到120秒（120000ms）
  2. 为文件上传请求特别设置更长的超时时间600秒（600000ms，10分钟）
  3. 在请求拦截器中检测URL是否包含'/upload'来识别上传请求
  4. 为上传请求单独设置更长的超时时间，确保大文件有足够的上传时间

- 修改文件：
  - `ruoyi-ui/src/utils/request.js`

### 总结
通过增加请求超时时间，特别是为文件上传请求设置更长的超时时间，解决了上传大文件时出现的超时问题。这个修改使系统能够处理更大的文件上传，提高了系统的稳定性和用户体验。 

## 2025-07-13 修复批量下载响应重置问题

### 问题描述
批量下载文件时出现`java.lang.IllegalStateException: Cannot call reset() after response has been committed`异常，导致下载失败。

### 问题原因
当批量文件下载遇到IOException时，代码直接调用了`response.reset()`方法，但没有先检查响应是否已提交。根据HTTP协议，一旦响应已经开始向客户端写入数据，就不能再调用reset()方法。

### 修复内容
1. 在`SysFileServiceImpl.batchDownloadFile`方法的异常处理部分添加响应状态检查：
   - 增加`if (!response.isCommitted())`判断，仅在响应未提交时才调用reset()
   - 当响应已提交时，只记录错误日志，不再尝试重置响应
   - 改进日志处理，使用log.error替代ioe.printStackTrace()
   - 保持与单文件下载方法中异常处理逻辑一致

### 效果
修复后，批量下载功能在遇到IO异常时不会再出现响应重置错误，而是根据响应状态采取合适的处理方式，提高了下载功能的稳定性和可靠性。

### 修改文件
- `ruoyi-filemanager/src/main/java/com/ruoyi/filemanager/service/impl/SysFileServiceImpl.java` 